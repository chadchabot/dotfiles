#!/bin/bash

# Ensure that source and destination paths are provided
if [ $# -ne 2 ]; then
  echo "Usage: $0 <source_directory> <destination_directory>"
  exit 1
fi

source_path="$1"
dest_path="$2"

echo -e "Comparing file content differences between:\n\t$source_path\n\t$dest_path\n\n"

# Initialize counts
source_count=0
dest_count=0
diff_count=0
total_checked=0

# Function to print progress
print_progress() {
  echo -ne "\rFiles checked: $total_checked | Only in source: $source_count | Only in dest: $dest_count | Differing: $diff_count"
}

# Check if source directory exists
if [ ! -d "$source_path" ]; then
  echo "Source directory does not exist: $source_path"
  exit 1
fi

# Check if destination directory exists
if [ ! -d "$dest_path" ]; then
  echo "Destination directory does not exist: $dest_path"
  exit 1
fi

# Check if source directory is empty
if [ "$(ls -A $source_path)" ]; then
    source_is_empty=false
else
    source_is_empty=true
    echo "Source directory is empty: $source_path"
fi

# Use rsync to get differences and handle output
rsync -anr --itemize-changes "$source_path/" "$dest_path/" | while IFS= read -r line; do
  ((total_checked++))

  # Full path construction
  full_source_path="$source_path/$(echo $line | sed 's/^[^ ]* //')"
  full_dest_path="$dest_path/$(echo $line | sed 's/^[^ ]* //')"

  # Output missing or differing files with full paths
  if echo "$line" | grep -q '^<'; then
    # File only in source
    echo "Only in source: $full_source_path"
    ((source_count++))
  elif echo "$line" | grep -q '^>'; then
    # File only in destination
    echo "Only in destination: $full_dest_path"
    ((dest_count++))
  elif echo "$line" | grep -q 'diff'; then
    # File differs between source and destination
    echo "Differing file: $full_source_path"
    ((diff_count++))
  fi

  # Print progress update
  print_progress
done

# Output final directory comparison
if [ "$source_is_empty" = true ]; then
  echo "Source directory is empty, no files to compare."
fi

# Final output summary
echo -e "\nComparison complete!"
echo "Files only in source ($source_path): $source_count"
echo "Files only in destin
